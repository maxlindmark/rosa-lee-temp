---
title: "Basic Rosa Lee from age-structured population with growth platoons"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: 
  html:
    toc: true
    page-layout: full
    embed-resources: true
knitr: 
  opts_chunk:
    fig.align: center
    out-width: 80%
editor: source
execute: 
  echo: true
  eval: true
  cache: false
---

### Introduction

The Rosa Lee effect states that the older the fish, the smaller the size when back-calculated to a given age (Lee 1912). The proposed causes for this pattern are many (see Duncan 1980), but a popular one is size-selective mortality; a fished population to a higher degree consists of slow-growing individuals, as faster growing fish are caught by fishing gear to a higher degree (Ricker 1969).

My understanding is that it's a relatively well known feature, although perhaps too often ignored in both the fisheries world (but see Kraak et al 2019), but perhaps mainly the "warming effects on growth"-world. At the same time, most long-term studies on temperature effects of fish growth and size are from commercially exploited fish species, which also have experience some degree of warming over the last years. This means that estimated temperature effects could be biased. While some studies mention this bias in this context and try to correct for it by including catch-at-age as a variable in a growth model (Berggren et al 2022), or just mentioning this connection (Saulamo et al 2020), this is far from the norm, and I'm not aware of any simulation study showing this bias (but see Kraak et al 2019 for an example tailored to the western Baltic cod).

This is also true for me, and I often think it would be nice to have a paper in the literature that clearly shows how growth parameters can be biased due to the Rosa Lee effect. Hence, here's an attempt to simulate a generic population (with a model that is capable of having a Rosa Lee effect) with semi-factorial setup of without fishing (and hence Rosa Lee effect), temperature effects on growth (K), and rates of warming. Expansions could include different life histories of fishes, and/or more variations on rates of warming and temperature effects on K. Basically, I'd like a paper to cite whenever I suspect that size-selective fishing might have affected my growth estimates (and in what direction the bias is) from time series of warming in a commercially exploited fish stock.

The most generic example of an operating model I can think of is a deterministic, age-structured population model with multiple growth morphs (platoons), incorporating length-based selectivity and Beverton-Holt stock–recruitment dynamics. The key feature that allows for the Rosa Lee effect to emerge from size-selective fishing is the platoon, which is inspired by the SS3 feature (Taylor & Method Jr 2013).  This script contains code to simulate a basic age-based population with growth platoons, loosely based on [SS3](https://nmfs-ost.github.io/ss3-doc/SS330_User_Manual_release.html#BH), with different fishing patterns to recapture the Rosa Lee effect.

### Load libraries

```{r libs}
#| message: false
#| warning: false

library(viridis)
library(ggdist)
library(patchwork)
library(viridis)
library(tidyverse)
library(ggsidekick) 
theme_set(theme_sleek())

# Set path
home <- here::here()
```

### Define individual and population-level parameters

```{r}
#| message: false
#| warning: false

# Model parameters
set.seed(123)
n_years <- 100
n_ages <- 15
n_platoons <- 250  # Number of growth morphs/platoons
ages <- 0:(n_ages-1)

# Life history parameters
M <- 0.2           # Natural mortality
steep <- 0.7       # Steepness
R0 <- 1000         # Unfished recruitment (thousands)
mat_age <- 3       # Age at 50% maturity
mat_slope <- 0.5

# Selectivity parameters (logistic)
sel_age50 <- 4
sel_slope <- 0.8

# Growth parameters by platoon (von Bertalanffy)
# Each platoon has different VBGE pars
K_vals <- rnorm(n_platoons, mean = 0.3, sd = 0.1)

growth_params <- tibble(
  platoon = 1:n_platoons,
  Linf = 80,
  K = K_vals,
  t0 = -0.5,
  CV_old = 0.1,     # <! not used! Can use it for intra-platoon variability. 
  prop = 1/n_platoons
)

# Length-weight parameters
a_lw <- 0.01
b_lw <- 3

# Calculate length and weight at age for each platoon
size_at_age <- growth_params |>
  crossing(age = ages) |>
  mutate(
    length = Linf * (1 - exp(-K * (age - t0))),
    weight = a_lw * length^b_lw
  ) |> 
  select(platoon, age, Linf, K, t0, CV_old, length, weight)

# Maturity
maturity <- tibble(age = ages) |>
  mutate(
    maturity = plogis((age - mat_age) / mat_slope)
  )

# Selectivity needs to be size-based for Rosa Lee to occur:
L50_len <- 40   # length at 50% vulnerability (cm)
len_slope <- 1  # slope (larger => gentler logistic)

# Build length-based selectivity per platoon x age using size_at_age
selectivity <- size_at_age |>
  mutate(selectivity = plogis((length - L50_len) / len_slope)) |>
  select(platoon, age, length, selectivity)

# Plot distribution of base K values in the population
ggplot(growth_params, aes(K)) + 
  geom_histogram() + 
  coord_cartesian(expand = 0)

# Plot maturity, selectivity and intra-cohort size and K difference in the population
ggplot(selectivity, aes(length, selectivity)) + 
  geom_line()

ggplot(selectivity, aes(age, selectivity)) + 
  geom_jitter(height = 0, width = 0.2)

ggplot(maturity, aes(age, maturity)) +
  geom_line() +
  scale_x_continuous(breaks = 1:10)

# Check size difference here 
size_at_age |>
  filter(age == 5) |>
  summarise(
    min_length = min(length),
    max_length = max(length),
    min_K = min(K),
    max_K = max(K)
  )
```

### Initialize the population

```{r}
# Get initial population values
init_pop <- crossing(
  year = 1,
  age = ages,
  platoon = 1:n_platoons
) |>
  left_join(growth_params |> select(platoon, prop), by = "platoon") |>
  mutate(
    # Unfished equilibrium age structure
    N = R0 * prop * exp(-M * age),
    N = if_else(age == max(age), N / (1 - exp(-M)), N)  # Plus group
  ) |>
  left_join(size_at_age, by = c("age", "platoon")) |>
  left_join(maturity, by = "age") |> 
  left_join(selectivity |> select(platoon, age, selectivity),
            by = c("platoon", "age")) |>
  mutate(selectivity = ifelse(is.na(selectivity), 0, selectivity))

glimpse(init_pop)

init_pop |> 
  summarise(n = sum(N), .by = c(year, age)) |> 
  ggplot(aes(age, n)) + 
  geom_bar(stat = "identity") +
  coord_cartesian(expand = 0)
```

Calculate unfished SSB (needed for S-R)

```{r}
SSB0 <- init_pop |>
  mutate(SSB_contrib = N * weight * maturity) |>
  summarise(SSB0 = sum(SSB_contrib)) |>
  pull(SSB0)
```

### Define functions

```{r}
# Beverton-Holt stock-recruitment function
# ss3 style! https://nmfs-ost.github.io/ss3-doc/SS330_User_Manual_release.html#BH
beverton_holt <- function(SSB, R0, steep, SSB0) {
  4 * steep * R0 * SSB / (SSB0 * (1 - steep) + SSB * (5 * steep - 1))
}

# Population dynamics simulation
pop_dynamics <- function(init_pop, n_years, M, R0, steep, SSB0, F_pattern, selectivity,
                         size_at_age, maturity, growth_params, ages) {
  
  # Only keep dynamic columns in pop: year, age, platoon, N
  pop <- init_pop |> select(year, age, platoon, N)
  
  for (y in 2:n_years) {
    
    prev <- pop |> filter(year == y - 1)
    
    # Aggregate by age x platoon
    prev_unique <- prev |>
      summarise(N = sum(N), .by = c(age, platoon))
    
    # Join size, maturity, selectivity for SSB calculation
    prev_unique <- prev_unique |>
      left_join(size_at_age, by = c("age", "platoon")) |>
      left_join(maturity, by = "age") |>
      # Remove length here because it's already in the x df. This is still correct though because
      # selectivity is length-based, but unique for each age and platoon
      left_join(selectivity |> dplyr::select(-length), by = c("age", "platoon")) |>
      mutate(selectivity = ifelse(is.na(selectivity), 0, selectivity))
    
    # Calculate SSB
    SSB <- sum(prev_unique$N * prev_unique$weight * prev_unique$maturity)
    
    # Recruitment
    recruits <- beverton_holt(SSB, R0, steep, SSB0)
    
    # Fishing mortality (given input)
    F_y <- F_pattern |> filter(year == y) |> pull(F_mult)
    
    # Apply mortality and age
    aged <- prev_unique |>
      mutate(
        F = F_y * selectivity,
        Z = M + F,
        N_aged = N * exp(-Z),
        age = age + 1
      )
    
    # Regular ages
    new_year <- aged |>
      filter(age < max(ages)) |>
      summarise(N = sum(N_aged), .by = c(age, platoon)) |>
      mutate(year = y)
    
    # Plus group
    plus_group <- aged |>
      filter(age == max(ages)) |>
      mutate(N = N_aged, year = y) |>
      select(year, age, platoon, N)
    
    # <! with "heritabilit"
    # This is not strictly true to default Rosa Lee, which is mainly phenotypical
    # Recruits inherit spawner composition (else platoon structure just gets refreshed!)
    # spawn_by_platoon <- prev_unique |>
    #   mutate(spawn_contrib = N * weight * maturity) |>
    #   summarise(SSB_platoon = sum(spawn_contrib), .by = platoon) |>
    #   mutate(prop_spawn = SSB_platoon / sum(SSB_platoon))
    # 
    # recruits_df <- spawn_by_platoon |>
    #   mutate(year = y, age = 0, N = recruits * prop_spawn) |>
    #   select(year, age, platoon, N)
    
    # No heritability
    recruits_df <- growth_params |>
      select(platoon, prop) |>
      mutate(year = y, age = 0, N = recruits * prop)
    
    # Combine
    new_year <- bind_rows(new_year, plus_group, recruits_df)
    
    # Append to population
    pop <- bind_rows(pop, new_year) |> 
      dplyr::select(-prop)
  }
  
  return(pop)
}
```

Define fishing scenarios

```{r}
# Fishing mortality pattern (ramp up then stabilize)
F_longterm <- 0.4

F_pattern <- tibble(year = 1:n_years) |>
  mutate(
    F_mult = case_when(
      year <= 5 ~ 0,           
      year <= 15 ~ (year - 5) / 10 * F_longterm,
      TRUE ~ F_longterm               
    )
  )

ggplot(F_pattern, aes(year, F_mult)) + 
  geom_line()
```

### Run simulations

We run two simulations: one without fishing and one with the fishing scenario. The `pop_dynamics` returns N by year, age and platoon ID.

```{r}
F_pattern_unfished <- tibble(year = 1:n_years, F_mult = 0)

# Run fished scenario
pop_sim_fished <- pop_dynamics(
  init_pop = init_pop,
  n_years = n_years,
  M = M,
  R0 = R0,
  steep = steep,
  SSB0 = SSB0,
  F_pattern = F_pattern,
  selectivity = selectivity,
  size_at_age = size_at_age,
  maturity = maturity,
  growth_params = growth_params,
  ages = ages
)

pop_sim_unfished <- pop_dynamics(
  init_pop = init_pop,
  n_years = n_years,
  M = M,
  R0 = R0,
  steep = steep,
  SSB0 = SSB0,
  F_pattern = F_pattern_unfished,  # No fishing
  selectivity = selectivity,
  size_at_age = size_at_age,
  maturity = maturity,
  growth_params = growth_params,
  ages = ages
)

pop_sim <- bind_rows(
  pop_sim_fished |> mutate(scenario = "Fished"),
  pop_sim_unfished |> mutate(scenario = "Unfished")
  )
```

### Plot the outcome of the population dynamics

```{r}
#| message: false
#| warning: false

# Ensure population size and age composition is stable over time (some kind of equilibrium)
pop_sim |>
  summarise(n = sum(N), .by = c(year, age, scenario)) |>
  ggplot(aes(year, n, fill = as.factor(age))) +
  scale_fill_viridis(discrete = TRUE) +
  facet_wrap(~scenario) +
  labs(fill = "age") +
  coord_cartesian(expand = 0) +
  geom_area(stat = "identity")

# Age & size structure
pop_sim |>
  # FIXME should probably take average of last 10 years or so
  # FIXME also, what about + group here. We sample with N weights, so we'll sample a lot from that group
  filter(year == max(year)) |> 
  summarise(N = sum(N), .by = c(year, age, scenario)) |>
  ggplot(aes(x = age, weight = N, fill = scenario)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(expand = 0) +
  labs(
    x = "Age",
    y = "Number of fish"
  )

# Compare K distributions at last year by fishing scenario
comparison <- pop_sim |>
  filter(year == max(year)) |> 
  left_join(growth_params |>
              select(platoon, K), by = "platoon")

comparison |>
  summarise(K_weighted = sum(K * N) / sum(N), .by = scenario)

comparison |>
  filter(age >= 4) |> 
  summarise(K_weighted = sum(K * N) / sum(N), .by = scenario)
```

```{r}
#| message: false
#| warning: false
#| fig-height: 10

# Plot distribution of K by age in fishing scenario
# For letting point size correspond to relative abundance of age class
age_abund <- comparison |>
  filter(scenario == "Fished", age <= 9, age > 1) |>
  summarise(totalN = sum(N), .by = age) |>
  mutate(rel_abund = totalN / sum(totalN))

sampled <- comparison |>
  filter(scenario == "Fished", age <= 9, age > 1) |>
  group_by(age) |>
  slice_sample(n = 200, weight_by = N, replace = TRUE) |>
  ungroup() |>
  left_join(age_abund, by = "age")   # attach relative abundances

ddw   <- 0.85

pal <- viridis(20, option = "mako")[8:15]

p1 <- ggplot(sampled,
            aes(x = as.factor(age), y = K, fill = as.factor(age), color = as.factor(age))) +
  geom_hline(yintercept = mean(growth_params$K),
             linetype = 2, alpha = 0.7) +
  stat_halfeye(
    aes(size = NULL),
    adjust = 0.7, .width = c(0.5, 0.9),
    justification = -0.2,
    point_interval = mean_qi,
    alpha = 0.55, color = NA,
    position = position_dodge(width = ddw)
  ) +
  geom_jitter(
    data = sampled,
    aes(x = as.factor(age), y = K, fill = as.factor(age), size = rel_abund),
    position = position_jitterdodge(dodge.width = ddw, jitter.width = 0.6, jitter.height = 0),
    alpha = 0.35, shape = 21, color = "white"
  ) +
  geom_pointrange(
    data = sampled |> 
      summarise(mean = mean(K), 
                ymin = quantile(K, 0.25), 
                ymax = quantile(K, 0.75), .by = age),
    aes(x = as.factor(age), y = mean, ymin = ymin, ymax = ymax),
    position = position_dodge(width = ddw), 
    color = "grey20",
    size = 0.5,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  scale_size_continuous(range = c(1.2, 3), name = "Relative\nabundance") +
  labs(x = "Age", y = "Growth coefficient (K)", fill = "Age", color = "Age") +
  theme(legend.position = "bottom") +
  guides(size = guide_legend(override.aes = list(alpha = 1, color = "black"),
                             title.position = "top", title.hjust = 0.5),
         color = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5),
         fill = "none")

# Difference in size at age 4 for these K
comparison |>
  filter(age >= 4) |>
  summarise(K_weighted = sum(K * N) / sum(N), .by = scenario) |>
  mutate(l_4 = mean(growth_params$Linf) * (1 - exp(-K_weighted * (4 - mean(growth_params$t0)))))

mean_growth <- comparison |>
  filter(age >= 4) |> 
  summarise(K_weighted = sum(K * N) / sum(N), .by = scenario) |> 
  crossing(age = 0:15) |> 
  mutate(length = mean(growth_params$Linf) * (1 - exp(-K_weighted * (age - mean(growth_params$t0)))),
         length_upr = mean(growth_params$Linf) * (1 - exp(-quantile(growth_params$K, 0.95) * (age - mean(growth_params$t0)))),
         length_lwr = mean(growth_params$Linf) * (1 - exp(-quantile(growth_params$K, 0.05) * (age - mean(growth_params$t0)))))

# Number of individuals to sample per scenario
n_sample <- 30

sample_individuals <- function(df, n) {
  # Sample individuals proportional to N
  df_sample <- df |>
    slice_sample(n = n, weight_by = N, replace = TRUE) |>
    left_join(growth_params |> select(-prop), by = "platoon") |>
    ungroup() |>  # Remove any existing grouping
    mutate(individual = row_number())  # Unique ID across all scenarios
  
  # Expand each individual to have rows for ages 0 through their actual age
  df_lengths <- df_sample |>
    reframe(
      age_vec = 0:age,
      .by = everything()
    ) |>
    mutate(
      length_vec = Linf * (1 - exp(-K * (age_vec - t0)))
    )
  
  return(df_lengths)
}

# Sample fish and back-calculate growth
samps <- pop_sim |> 
  filter(year == max(year)) |> 
  filter(age >= 7) |> # else we only get youngsters
  group_by(scenario) |> 
  sample_individuals(n_sample) |> 
  ungroup()

# Plot
p2 <- ggplot(samps, aes(x = age_vec, y = length_vec, group = individual, color = scenario)) +
  geom_line(alpha = 0.4, linewidth = 0.35) + 
  geom_line(data = mean_growth,
            aes(age, length, color = scenario),
            linewidth = 1.5, inherit.aes = FALSE) + 
  labs(x = "Age", y = "Length (cm)") +
  scale_color_brewer(palette = "Set2") +
  theme(legend.position = "bottom",
        legend.title = element_blank())

(p1 / p2) & theme(legend.position = "right")

ggsave(paste0(home, "/figures/base_output.pdf"), width = 17, height = 17, units = "cm")
```

### Conclusions & next steps

* This basic example shows that the operating model can retrieve the Rosa Lee effect under fishing, in that the growth coefficients K are lower in the fished population, especially among older ages.

* Next step: define a simulation test with warming over time, and temperature dependence on K

### References
Berggren, T., Bergström, U., Sundblad, G., & Östman, Ö. (2022). Warmer water increases early body growth of northern pike (Esox lucius), but mortality has larger impact on decreasing body sizes. Canadian Journal of Fisheries and Aquatic Sciences, 79(5), 771–781. <https://doi.org/10.1139/cjfas-2020-0386>

Duncan, K. W. (1980). On the back‐calculation of fish lengths; modifications and extensions to the Fraser‐Lee equation. Journal of Fish Biology, 16(6), 725–730. <https://doi.org/10.1111/j.1095-8649.1980.tb03751.x>

Kraak, S. B. M., Haase, S., Minto, C., & Santos, J. (2019). The Rosa Lee phenomenon and its consequences for fisheries advice on changes in fishing mortality or gear selectivity. ICES Journal of Marine Science, 76(7), 2179–2192. <https://doi.org/10.1093/icesjms/fsz107>

Lee, R. M. (1912). An investigation into the methods of growth determination in fishes. Conseil Permanent International pour l’Exploration de la Mer, Publications de Circonstance, 63. 35 pp.

Ricker, W. E. (1969). Effects of Size-Selective Mortality antl Sarnpling Bias on Estirnates of Growtho Mortality, Production, and Yield. J. Fish. Res. Board Can., 26, 479–541.

Saulamo, K., Heikinheimo, O., & Lappalainen, J. (2020). Density and temperature dependent growth of pikeperch ( Sander lucioperca ) in the Archipelago Sea. Aquatic Living Resources, 33, 22. <https://doi.org/10.1051/alr/2020020>

Taylor, I. G., & Methot, R. D. (2013). Hiding or dead? A computationally efficient model of selective fisheries mortality. Fisheries Research, 142, 75–85. <https://doi.org/10.1016/j.fishres.2012.08.021>

